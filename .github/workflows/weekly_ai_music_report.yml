name: Weekly AI Music Report

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: false
        default: 'false'
  schedule:
    - cron: '0 1 * * 1'  # Monday 9AM Beijing time (UTC+8), 1AM UTC

jobs:
  generate_report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
    
    - name: Clear npm cache
      run: |
        npm cache clean --force
        rm -rf ~/.npm node_modules package-lock.json
        npm config set registry https://registry.npmjs.org/
        npm config set fetch-retries 10
        npm config set prefer-online true
    
    - name: Install dependencies
      run: |
        for i in {1..3}; do
          if npm install --no-audit --no-fund --prefer-online; then
            echo "âœ… Dependencies installed successfully"
            break
          else
            echo "âŒ Attempt $i failed, retrying..."
            npm cache clean --force
            rm -rf node_modules
            sleep 5
          fi
        done
    
    - name: Generate report
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      run: |
        echo "ðŸš€ Starting AI Music Weekly Report..."
        echo "ðŸ“‡ Current time: $(date)"
        echo "ðŸ–˜ Beijing time: $(TZ=Asia/Shanghai date)"
        
        if [ -f "scripts/generateWeeklyReport.js" ]; then
          node scripts/generateWeeklyReport.js
        else
          echo "âŒ Script file not found"
          ls -la scripts/
          exit 1
        fi
    
    - name: Summary
      if: always()
      run: |
        echo "## ðŸ“Š Weekly AI Music Report" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time:** $(TZ=Asia/Shanghai date)" >> $GITHUB_STEP_SUMMARY
