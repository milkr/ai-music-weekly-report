name: Weekly AI Music Report

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: false
        default: 'false'
  schedule:
    - cron: '0 1 * * 1'  # Monday 9AM Beijing time (UTC+8), 1AM UTC

jobs:
  generate_report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
    
    - name: Clear npm cache
      run: |
        npm cache clean --force
        rm -rf ~/.npm node_modules package-lock.json
        npm config set registry https://registry.npmjs.org/
        npm config set fetch-retries 10
        npm config set prefer-online true
    
    - name: Install dependencies
      run: |
        for i in {1..3}; do
          if npm install --no-audit --no-fund --prefer-online; then
            echo "âœ… Dependencies installed successfully"
            break
          else
            echo "âŒ Attempt $i failed, retrying..."
            npm cache clean --force
            rm -rf node_modules
            sleep 5
          fi
        done
    
    - name: Generate report
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      run: |
        echo "ðŸš€ Starting AI Music Weekly Report..."
        echo "ðŸ“‡ Current time: $(date)"
        echo "ðŸ–˜ Beijing time: $(TZ=Asia/Shanghai date)"
        
        if [ -f "scripts/generateWeeklyReport.js" ]; then
          node scripts/generateWeeklyReport.js
        else
          echo "âŒ Script file not found"
          ls -la scripts/
          exit 1
        fi
    
    - name: Update Google Sheets
      if: env.GOOGLE_SHEET_ID != ''
      uses: jroehl/gsheet.action@v1.0.0
      with:
        spreadsheetId: ${{ secrets.GOOGLE_SHEET_ID }}
        commands: |
          [
            {
              "command": "addWorksheet",
              "args": {
                "worksheetTitle": "AI Music Report $(date +%Y%m%d)"
              }
            },
            {
              "command": "updateData",
              "args": {
                "worksheetTitle": "AI Music Report $(date +%Y%m%d)",
                "data": [
                  ["æ—¥æœŸ", "æ•°æ®ç±»åž‹", "æ•°é‡", "è¯´æ˜Ž"],
                  ["$(date +%Y-%m-%d)", "æ€»å¸–å­æ•°", "150", "æ¨¡æ‹Ÿæ•°æ®"],
                  ["$(date +%Y-%m-%d)", "æŽ¨ç‰¹å¸–å­", "80", "æ¨¡æ‹Ÿæ•°æ®"],
                  ["$(date +%Y-%m-%d)", "Redditå¸–å­", "70", "æ¨¡æ‹Ÿæ•°æ®"],
                  ["$(date +%Y-%m-%d)", "SunoæåŠ", "45", "æ¨¡æ‹Ÿæ•°æ®"],
                  ["$(date +%Y-%m-%d)", "UdioæåŠ", "28", "æ¨¡æ‹Ÿæ•°æ®"]
                ]
              }
            }
          ]
      env:
        GSHEET_CLIENT_EMAIL: ${{ secrets.GSHEET_CLIENT_EMAIL }}
        GSHEET_PRIVATE_KEY: ${{ secrets.GSHEET_PRIVATE_KEY }}
    
    - name: Summary
      if: always()
      run: |
        echo "## ðŸ“Š Weekly AI Music Report" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time:** $(TZ=Asia/Shanghai date)" >> $GITHUB_STEP_SUMMARY
